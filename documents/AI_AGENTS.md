# AI Agents Reference - Mudskipper QMS

**Critical**: This project uses **AWS Amplify Gen 2** (NOT Gen 1). Do not use Gen 1 patterns or documentation.

## Tech Stack

- **Frontend**: React 18 + Vite + TypeScript
- **Backend**: AWS Amplify Gen 2
- **Authentication**: AWS Cognito User Pools
- **Database**: Amazon DynamoDB (via Amplify Data)
- **Serverless Functions**: AWS Lambda
- **API**: GraphQL (auto-generated by Amplify Data)

## What Exists

### Data Models
- **Users** model only (`amplify/data/resource.ts`)
  - Fields: `id`, `email`, `first_name`, `last_name`, `permission_level` (1-5), `status`, `invited_by`, `created_at`, `updated_at`
  - Authorization: Owner-based (`.authorization((allow) => [allow.owner()])`)

### Lambda Functions
- **inviteUser** (`amplify/functions/inviteUser/`)
  - Creates user in Cognito + Users table
  - Handles `UsernameExistsException` gracefully
- **updateUserPermission** (`amplify/functions/updateUserPermission/`)
  - Updates user's permission level

### Frontend Components
- **Layout** (`src/components/Layout.tsx`) - Header, Sidebar, Main content
- **Header** (`src/components/Header.tsx`) - Top navigation bar
- **FolderTree** (`src/components/FolderTree.tsx`) - Placeholder only
- **Admin** page (`src/pages/Admin.tsx`) - User management (Level 5 only)
- **Admin components**: `InviteUserDialog`, `EditPermissionDialog`

### Utilities
- **Permissions** (`src/auth/permissions.ts`)
  - `getCurrentUserPermissionLevel(user)` - Queries Users table by email
  - `isSuperAdmin(level)` - Returns true if level >= 5

## What Does NOT Exist

- ❌ Router library (using pathname-based routing in `App.tsx`)
- ❌ Folder model or folder system (placeholder only)
- ❌ Document model
- ❌ Task model
- ❌ Log model
- ❌ Canvas model
- ❌ Global state management (using React `useState` only)
- ❌ Error UI component (using `alert()` currently)
- ❌ Automated tests

## Common Mistakes to Avoid

### ❌ DO NOT assume Amplify Gen 1
- **Wrong**: Using `amplify init`, `amplify add api`, CLI commands
- **Right**: Use `npx ampx sandbox`, define resources in `amplify/` directory

### ❌ DO NOT create files that already exist
- Check `src/components/` before creating new components
- Check `src/pages/` before creating new pages
- Check `amplify/functions/` before creating new functions

### ❌ DO NOT assume router library
- **Wrong**: Using React Router, Next.js routing, or `useNavigate()`
- **Right**: Pathname-based routing in `App.tsx` using `window.location.pathname`

### ❌ DO NOT assume features exist
- Folders, Documents, Tasks, Logs, Canvas - **NOT IMPLEMENTED YET**
- Check `REQUIREMENTS.md` for what's planned, but don't assume it exists

### ❌ DO NOT use wrong Amplify patterns
- **Wrong**: `API.graphql()`, `DataStore`, `Auth.currentAuthenticatedUser()`
- **Right**: `generateClient<Schema>()` from `aws-amplify/data`, `useAuthenticator()` from `@aws-amplify/ui-react`

## Authentication & Permissions

### Invite-Only Flow
1. Admin (Level 5) invites user via `/admin` page
2. `inviteUser` Lambda creates user in Cognito + Users table
3. User receives email with temporary password
4. User signs in and sets permanent password

### Permission System
- **Level 1-4**: To be defined per feature
- **Level 5**: Super Admin (can access `/admin`, manage users)
- Permission checking: Use `getCurrentUserPermissionLevel(user)` from `src/auth/permissions.ts`
- User email comes from `user.signInDetails.loginId` (Cognito)

### Signup Disabled
- `src/main.tsx` has `<Authenticator hideSignUp={true}>`
- No signup option in UI (invite-only)

## Lambda Functions

### Structure
- Each function: `amplify/functions/{name}/resource.ts` (config) + `handler.ts` (code)
- Registered in `amplify/backend.ts`
- Use Lambda Function URLs (direct HTTPS endpoints)
- CORS configured in AWS Console (not in code - no CORS headers in handlers)

### inviteUser
- **Input**: `{ email, firstName?, lastName?, permissionLevel, invitedBy }`
- **Does**: Creates Cognito user + Users table record
- **Env vars**: `USER_POOL_ID`, `TABLE_USERS` (hardcoded - known issue)
- **IAM**: Needs `cognito-idp:AdminCreateUser`, `dynamodb:PutItem`

### updateUserPermission
- **Input**: `{ userId, permissionLevel, updatedBy }`
- **Does**: Updates `permission_level` and `updated_at` in Users table
- **Env vars**: `TABLE_USERS` (hardcoded - known issue)
- **IAM**: Needs `dynamodb:UpdateItem`

## Frontend Patterns

### Routing
```typescript
// src/App.tsx - pathname-based, no router library
const path = typeof window !== "undefined" ? window.location.pathname : "/";
if (path === "/admin") {
  return <Layout><AdminPage /></Layout>;
}
return <Layout><div>Welcome...</div></Layout>;
```

### Data Fetching
```typescript
// Amplify Data client
import { generateClient } from "aws-amplify/data";
import type { Schema } from "../amplify/data/resource";
const client = generateClient<Schema>();
const { data } = await client.models.Users.list();

// Lambda function call
await fetch(FUNCTION_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ ... }),
});
```

### Layout Usage
```typescript
// All pages wrapped in Layout
<Layout>
  <YourContent />
</Layout>
```

## Known Issues (Fix Before Production)

1. **Hardcoded Function URLs** in `src/pages/Admin.tsx` - Read from `amplify_outputs.json` instead
2. **Hardcoded User Pool ID/Table Names** in function `resource.ts` files - Reference resources properly
3. **Missing `owner` field** in Users creation - Set to Cognito username
4. **No admin permission checks** in Lambda handlers - Add JWT validation
5. **Manual IAM permissions** - Should be in Amplify resource definitions
6. **CORS in Console** - Should be in code
7. **Error handling with `alert()`** - Needs proper UI component

## Key Files

- **Add model**: `amplify/data/resource.ts`
- **Add function**: `amplify/functions/{name}/` + register in `amplify/backend.ts`
- **Add page**: `src/pages/` + update routing in `src/App.tsx`
- **Add component**: `src/components/`
- **Check permissions**: `src/auth/permissions.ts`

## References

- **Requirements**: `documents/REQUIREMENTS.md`
- **Amplify Gen 2 Docs**: https://docs.amplify.aws/gen2/

---

*Last Updated: 2025-01-16*
